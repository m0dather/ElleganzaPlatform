/**
 * Shopping Cart JavaScript Module
 * Handles all cart operations including add, update, remove, and display
 * Phase 3.1.1 Hardening: CSRF protection, error handling, validation
 */

(function ($) {
    'use strict';

    // Cart module
    window.Cart = {
        /**
         * Initialize cart functionality
         */
        init: function () {
            this.setupAjaxDefaults();
            this.bindEvents();
            this.updateCartCount();
            this.initMiniCart();
        },

        /**
         * Initialize mini cart functionality
         */
        initMiniCart: function () {
            const self = this;
            
            // Load mini cart content when offcanvas is shown
            $('#miniCart').on('show.bs.offcanvas', function () {
                self.loadMiniCart();
            });
        },

        /**
         * Setup AJAX defaults including CSRF token (Phase 3.1.1: Security Hardening)
         */
        setupAjaxDefaults: function () {
            // Get CSRF token from the hidden form field generated by @Html.AntiForgeryToken()
            const token = $('input[name="__RequestVerificationToken"]').val();
            
            if (token) {
                // Set up jQuery AJAX to send the anti-forgery token with all requests
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        // Only add token to POST, PUT, DELETE requests (not GET)
                        if (settings.type !== 'GET') {
                            xhr.setRequestHeader('RequestVerificationToken', token);
                        }
                    }
                });
            } else {
                console.warn('CSRF token not found. Ensure @Html.AntiForgeryToken() is present in _Layout.cshtml. Cart operations may fail.');
            }
        },

        /**
         * Bind event handlers
         */
        bindEvents: function () {
            const self = this;

            // Add to cart button (on product pages)
            $(document).on('click', '.btn-add-to-cart', function (e) {
                e.preventDefault();
                e.stopPropagation();
                const $btn = $(this);
                const productId = $btn.data('product-id');
                // Try multiple selector patterns for quantity input
                const $form = $btn.closest('form, .product-form, .tf-product-info-buy-button').parent();
                const $quantityInput = $form.find('input[name="number"], input.quantity-product, input[type="text"]').first();
                const quantity = $quantityInput.length ? parseInt($quantityInput.val()) || 1 : 1;

                if (!productId) {
                    console.error('Product ID is required to add to cart');
                    return;
                }

                self.addToCart(productId, quantity, $btn);
            });

            // Quick Add to cart button (on product cards)
            // Handles both #quick_add and .quick-add selectors
            // Prevents modal popup and directly adds product to cart
            $(document).on('click', '#quick_add, .quick-add, a[href="#quick_add"]', function (e) {
                e.preventDefault();
                e.stopPropagation(); // Prevent modal from opening
                
                const $btn = $(this);
                
                // Try to get product ID from multiple sources:
                // 1. Direct data attribute on button (kebab-case and camelCase)
                // 2. Data attribute on parent card (kebab-case and camelCase)
                // 3. Data attribute on closest product container
                let productId = $btn.data('product-id') || 
                               $btn.data('productId') ||
                               $btn.closest('.card-product, .product-item, [data-product-id]').data('product-id') ||
                               $btn.closest('.card-product, .product-item, [data-product-id]').data('productId');
                
                // Get quantity from data attribute or default to 1
                const quantity = parseInt($btn.data('product-qty') || $btn.data('qty') || 1);

                // Validate product ID exists
                if (!productId) {
                    console.warn('Quick Add: Product ID not found. Please ensure data-product-id attribute is set on the button or parent element.');
                    // Show themed error notification
                    if (window.UI && window.UI.notify) {
                        window.UI.notify.error('Unable to add product. Product information is missing.');
                    } else {
                        self.showMessage('Unable to add product. Product information is missing.', 'error');
                    }
                    return;
                }
                
                // Use the existing addToCart method which handles all the cart logic
                // including button state management (disable/enable, loading text, etc.)
                self.addToCart(productId, quantity, $btn);
            });

            // Update quantity in cart page
            $(document).on('click', '.btn-quantity', function (e) {
                e.preventDefault();
                const $btn = $(this);
                const $input = $btn.siblings('input[type="text"]');
                const productId = $input.data('product-id');
                let quantity = parseInt($input.val()) || 1;

                if ($btn.hasClass('btnincrease') || $btn.hasClass('plus-btn')) {
                    quantity++;
                } else if ($btn.hasClass('btndecrease') || $btn.hasClass('minus-btn')) {
                    quantity = Math.max(1, quantity - 1);
                }

                $input.val(quantity);

                if (productId) {
                    self.updateCartItem(productId, quantity);
                }
            });

            // Update quantity on input change (cart page)
            $(document).on('change', '.wg-quantity input[type="text"]', function () {
                const $input = $(this);
                const productId = $input.data('product-id');
                const quantity = parseInt($input.val()) || 1;

                if (productId) {
                    self.updateCartItem(productId, quantity);
                }
            });

            // Remove item from cart
            $(document).on('click', '.remove-cart', function (e) {
                e.preventDefault();
                const $btn = $(this);
                const productId = $btn.data('product-id');

                if (!productId) {
                    console.error('Product ID is required to remove from cart');
                    return;
                }

                // Use themed confirmation if available, otherwise fallback to browser confirm
                if (window.UI && window.UI.notify && window.UI.notify.confirm) {
                    window.UI.notify.confirm(
                        'Are you sure you want to remove this item from cart?',
                        function () {
                            self.removeFromCart(productId, $btn);
                        }
                    );
                } else {
                    if (confirm('Are you sure you want to remove this item from cart?')) {
                        self.removeFromCart(productId, $btn);
                    }
                }
            });
        },

        /**
         * Add product to cart
         */
        addToCart: function (productId, quantity, $btn) {
            const self = this;
            const originalText = $btn.html();

            // Disable button and show loading state
            $btn.prop('disabled', true).html('<span>Adding...</span>');

            $.ajax({
                url: '/cart/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    productId: parseInt(productId),
                    quantity: parseInt(quantity)
                }),
                success: function (response) {
                    if (response.success) {
                        // Show success message
                        self.showMessage('Product added to cart successfully!', 'success');
                        
                        // Update cart count
                        self.updateCartCount(response.cartCount);

                        // Check CartUIConfig to determine behavior
                        // Phase 3.3: Configurable Add To Cart UI Behavior
                        if (window.CartUIConfig && window.CartUIConfig.openMiniCartOnAdd) {
                            // MODE B: Open mini cart slider
                            const miniCartElement = document.getElementById('miniCart');
                            if (miniCartElement) {
                                const miniCart = new bootstrap.Offcanvas(miniCartElement);
                                miniCart.show();
                            }
                        }
                        // MODE A: Only update count (default behavior when openMiniCartOnAdd is false)
                        // Count is already updated above
                    } else {
                        self.showMessage(response.message || 'Failed to add product to cart', 'error');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to add product to cart';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    self.showMessage(errorMessage, 'error');
                },
                complete: function () {
                    // Re-enable button and restore text
                    $btn.prop('disabled', false).html(originalText);
                }
            });
        },

        /**
         * Update cart item quantity
         */
        updateCartItem: function (productId, quantity) {
            const self = this;

            $.ajax({
                url: '/cart/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    productId: parseInt(productId),
                    quantity: parseInt(quantity)
                }),
                success: function (response) {
                    if (response.success) {
                        // Update cart count
                        self.updateCartCount(response.cartCount);

                        // Update totals on the page
                        self.updateCartTotals(response);

                        // Update item total
                        const $row = $('[data-product-id="' + productId + '"]');
                        if ($row.length) {
                            const $priceElement = $row.find('.tf-cart-item_price .price');
                            // Remove all non-numeric chars except decimal and comma, then remove commas for parsing
                            const priceText = $priceElement.text().replace(/[^0-9.,-]/g, '').replace(/,/g, '');
                            const unitPrice = parseFloat(priceText) || 0;
                            const itemTotal = unitPrice * quantity;
                            const currencySymbol = $priceElement.text().match(/[^\d\s.,-]/)?.[0] || '$'; // Extract currency symbol
                            $row.find('.tf-cart-item_total .price').text(currencySymbol + itemTotal.toFixed(2));
                        }
                    } else {
                        self.showMessage(response.message || 'Failed to update cart', 'error');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to update cart';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    self.showMessage(errorMessage, 'error');
                }
            });
        },

        /**
         * Remove item from cart
         */
        removeFromCart: function (productId, $btn) {
            const self = this;
            const $row = $btn.closest('.tf-cart-item');

            $.ajax({
                url: '/cart/remove/' + productId,
                type: 'POST',
                success: function (response) {
                    if (response.success) {
                        // Remove the row with animation
                        $row.fadeOut(300, function () {
                            $(this).remove();

                            // Check if cart is empty
                            if ($('.tf-cart-item').length === 0) {
                                // Reload page to show empty cart message
                                window.location.reload();
                            } else {
                                // Update cart count and totals
                                self.updateCartCount(response.cartCount);
                                self.updateCartTotals(response);
                            }
                        });

                        self.showMessage('Item removed from cart', 'success');
                    } else {
                        self.showMessage(response.message || 'Failed to remove item', 'error');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to remove item from cart';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    self.showMessage(errorMessage, 'error');
                }
            });
        },

        /**
         * Update cart count in header
         */
        updateCartCount: function (count) {
            if (count === undefined) {
                // Fetch cart count from server
                $.ajax({
                    url: '/cart/count',
                    type: 'GET',
                    success: function (response) {
                        if (response && response.count !== undefined) {
                            $('.cart-count, .count-box').text(response.count);
                        }
                    }
                });
            } else {
                // Use provided count
                $('.cart-count, .count-box').text(count);
            }
        },

        /**
         * Update cart totals on page
         */
        updateCartTotals: function (data) {
            // Try to extract currency symbol from existing price elements, fallback to $
            const existingPriceElement = $('.price, .tf-totals-total-value').first();
            const currencySymbol = existingPriceElement.length ? 
                (existingPriceElement.text().match(/[^\d\s.,-]/)?.[0] || '$') : '$';
            
            if (data.subTotal !== undefined) {
                $('.tf-totals-total-value.subtotal').text(currencySymbol + data.subTotal.toFixed(2));
            }
            if (data.taxAmount !== undefined) {
                $('.tf-totals-total-value.tax').text(currencySymbol + data.taxAmount.toFixed(2));
            }
            if (data.shippingAmount !== undefined) {
                $('.tf-totals-total-value.shipping').text(currencySymbol + data.shippingAmount.toFixed(2));
            }
            if (data.totalAmount !== undefined) {
                $('.tf-totals-total-value.total').text(currencySymbol + data.totalAmount.toFixed(2));
            }
        },

        /**
         * Load mini cart data and render
         */
        loadMiniCart: function () {
            const self = this;
            const $content = $('#miniCartContent');

            // Show loading state
            $content.html('<div class="mini-cart-loading text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');

            $.ajax({
                url: '/cart/mini',
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        self.renderMiniCart(response);
                    } else {
                        self.showMessage('Failed to load cart', 'error');
                    }
                },
                error: function () {
                    $content.html('<div class="text-center py-5"><p class="text-danger">Failed to load cart</p></div>');
                }
            });
        },

        /**
         * Render mini cart HTML
         */
        renderMiniCart: function (data) {
            const $content = $('#miniCartContent');
            const currencySymbol = '$';

            if (!data.items || data.items.length === 0) {
                // Empty cart state
                $content.html(`
                    <div class="empty-cart text-center py-5">
                        <i class="icon icon-bag" style="font-size: 64px; color: #ccc;"></i>
                        <p class="mt-3 mb-3">Your cart is empty</p>
                        <a href="/shop" class="tf-btn btn-fill animate-hover-btn radius-3">
                            <span>Continue Shopping</span>
                        </a>
                    </div>
                `);
                return;
            }

            // Build cart items HTML
            let itemsHtml = '';
            data.items.forEach(function (item) {
                const imageUrl = item.imageUrl || '/images/products/default.jpg';
                itemsHtml += `
                    <div class="mini-cart-item d-flex gap-3 mb-3 pb-3 border-bottom" data-product-id="${item.productId}">
                        <div class="mini-cart-item-image">
                            <a href="/shop/product/${item.productId}">
                                <img src="${imageUrl}" alt="${item.productName}" style="width: 80px; height: 80px; object-fit: cover;">
                            </a>
                        </div>
                        <div class="mini-cart-item-info flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <a href="/shop/product/${item.productId}" class="mini-cart-item-name fw-semibold text-decoration-none">${item.productName}</a>
                                <button class="btn btn-sm btn-link text-danger p-0 mini-cart-remove" data-product-id="${item.productId}" title="Remove">
                                    <i class="icon icon-close"></i>
                                </button>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="mini-cart-quantity">
                                    <div class="wg-quantity d-flex align-items-center">
                                        <button class="btn btn-sm btn-outline-secondary mini-cart-qty-decrease" data-product-id="${item.productId}">-</button>
                                        <input type="text" class="form-control form-control-sm text-center mx-1" style="width: 50px;" value="${item.quantity}" readonly>
                                        <button class="btn btn-sm btn-outline-secondary mini-cart-qty-increase" data-product-id="${item.productId}">+</button>
                                    </div>
                                </div>
                                <div class="mini-cart-item-price fw-semibold">${currencySymbol}${item.totalPrice.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Build complete HTML
            const html = `
                <div class="mini-cart-header mb-3">
                    <h5 class="mb-0">Shopping Cart (${data.totalItems})</h5>
                </div>
                <div class="mini-cart-items mb-4" style="max-height: 400px; overflow-y: auto;">
                    ${itemsHtml}
                </div>
                <div class="mini-cart-footer">
                    <div class="mini-cart-totals mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span class="fw-semibold">${currencySymbol}${data.subTotal.toFixed(2)}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax:</span>
                            <span>${currencySymbol}${data.taxAmount.toFixed(2)}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                            <span>Shipping:</span>
                            <span>${data.shippingAmount > 0 ? currencySymbol + data.shippingAmount.toFixed(2) : 'Free'}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="fw-bold">Total:</span>
                            <span class="fw-bold fs-5">${currencySymbol}${data.totalAmount.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="mini-cart-actions d-grid gap-2">
                        <a href="/cart" class="tf-btn btn-outline-dark animate-hover-btn radius-3">
                            <span>View Cart</span>
                        </a>
                        <a href="/checkout" class="tf-btn btn-fill animate-hover-btn radius-3">
                            <span>Checkout</span>
                        </a>
                        <button class="btn btn-link text-danger mini-cart-clear-all" style="text-decoration: none;">
                            Clear Cart
                        </button>
                    </div>
                </div>
            `;

            $content.html(html);

            // Bind mini cart event handlers
            this.bindMiniCartEvents();
        },

        /**
         * Bind mini cart specific events
         * Uses event delegation on document for dynamically created elements
         */
        bindMiniCartEvents: function () {
            const self = this;
            const miniCartId = '#miniCartContent';

            // Use event delegation with more specific container
            // Quantity increase
            $(document).off('click.miniCart', '.mini-cart-qty-increase').on('click.miniCart', '.mini-cart-qty-increase', function (e) {
                e.preventDefault();
                const productId = $(this).data('product-id');
                const $input = $(this).siblings('input');
                const quantity = parseInt($input.val()) + 1;
                $input.val(quantity);
                self.updateMiniCartItem(productId, quantity);
            });

            // Quantity decrease
            $(document).off('click.miniCart', '.mini-cart-qty-decrease').on('click.miniCart', '.mini-cart-qty-decrease', function (e) {
                e.preventDefault();
                const productId = $(this).data('product-id');
                const $input = $(this).siblings('input');
                const quantity = Math.max(1, parseInt($input.val()) - 1);
                $input.val(quantity);
                self.updateMiniCartItem(productId, quantity);
            });

            // Remove item
            $(document).off('click.miniCart', '.mini-cart-remove').on('click.miniCart', '.mini-cart-remove', function (e) {
                e.preventDefault();
                const productId = $(this).data('product-id');
                
                // Use themed confirmation if available, otherwise fallback to browser confirm
                if (window.UI && window.UI.notify && window.UI.notify.confirm) {
                    window.UI.notify.confirm(
                        'Remove this item from cart?',
                        function () {
                            self.removeFromMiniCart(productId);
                        }
                    );
                } else {
                    if (confirm('Remove this item from cart?')) {
                        self.removeFromMiniCart(productId);
                    }
                }
            });

            // Clear all
            $(document).off('click.miniCart', '.mini-cart-clear-all').on('click.miniCart', '.mini-cart-clear-all', function (e) {
                e.preventDefault();
                
                // Use themed confirmation if available, otherwise fallback to browser confirm
                if (window.UI && window.UI.notify && window.UI.notify.confirm) {
                    window.UI.notify.confirm(
                        'Are you sure you want to clear your entire cart?',
                        function () {
                            self.clearMiniCart();
                        }
                    );
                } else {
                    if (confirm('Are you sure you want to clear your entire cart?')) {
                        self.clearMiniCart();
                    }
                }
            });
        },

        /**
         * Update item quantity in mini cart
         */
        updateMiniCartItem: function (productId, quantity) {
            const self = this;

            $.ajax({
                url: '/cart/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    productId: parseInt(productId),
                    quantity: parseInt(quantity)
                }),
                success: function (response) {
                    if (response.success) {
                        // Reload mini cart
                        self.loadMiniCart();
                        // Update header count
                        self.updateCartCount(response.cartCount);
                    } else {
                        self.showMessage(response.message || 'Failed to update item', 'error');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to update item';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    self.showMessage(errorMessage, 'error');
                }
            });
        },

        /**
         * Remove item from mini cart
         */
        removeFromMiniCart: function (productId) {
            const self = this;

            $.ajax({
                url: '/cart/remove/' + productId,
                type: 'POST',
                success: function (response) {
                    if (response.success) {
                        // Reload mini cart
                        self.loadMiniCart();
                        // Update header count
                        self.updateCartCount(response.cartCount);
                        self.showMessage('Item removed from cart', 'success');
                    } else {
                        self.showMessage(response.message || 'Failed to remove item', 'error');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to remove item';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    self.showMessage(errorMessage, 'error');
                }
            });
        },

        /**
         * Clear all items from cart
         */
        clearMiniCart: function () {
            const self = this;

            $.ajax({
                url: '/cart/clear',
                type: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function (response) {
                    if (response && response.success) {
                        // Reload mini cart to show empty state
                        self.loadMiniCart();
                        // Update header count
                        self.updateCartCount(0);
                        self.showMessage('Cart cleared successfully', 'success');
                    }
                },
                error: function () {
                    self.showMessage('Failed to clear cart', 'error');
                }
            });
        },

        /**
         * Show message to user
         * Uses themed UI notifications if available, falls back to alert
         */
        showMessage: function (message, type) {
            // Use UI.notify if available (Ecomus themed notifications)
            if (window.UI && window.UI.notify) {
                switch (type) {
                    case 'success':
                        window.UI.notify.success(message);
                        break;
                    case 'error':
                        window.UI.notify.error(message);
                        break;
                    case 'warning':
                        window.UI.notify.warning(message);
                        break;
                    default:
                        window.UI.notify.info(message);
                }
            } else if (typeof toastr !== 'undefined') {
                // Fallback to toastr if available
                toastr[type](message);
            } else {
                // Last resort: browser alert (should not happen with ui-notify.js loaded)
                alert(message);
            }
        }
    };

    // Initialize cart when DOM is ready
    $(document).ready(function () {
        Cart.init();
    });

})(jQuery);
